<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>1–° –ü–æ–¥–¥–µ—Ä–∂–∫–∞ ‚Äî –ê–¥–º–∏–Ω–∫–∞ —Å —Ñ–∏–ª—å—Ç—Ä–æ–º –ø–æ –∫–ª–∏–µ–Ω—Ç—É</title>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
  <style>
    :root {
      --primary: #1976d2;
      --primary-light: #63a4ff;
      --primary-dark: #004ba0;
      --success: #2e7d32;
      --warning: #ed6c02;
      --gray-100: #f5f5f5;
      --gray-200: #eeeeee;
      --gray-700: #616161;
      --border: #e0e0e0;
      --shadow: 0 4px 12px rgba(0,0,0,0.08);
      --radius: 12px;
      --transition: all 0.3s ease;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Roboto', sans-serif;
      background: var(--gray-100);
      color: #333;
      padding: 20px;
      line-height: 1.6;
    }

    .container {
      max-width: 1150px;
      margin: 0 auto;
      background: white;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    header {
      background: var(--primary);
      color: white;
      padding: 24px 32px;
      text-align: center;
    }

    header h1 {
      font-weight: 500;
      font-size: 28px;
    }

    .badge-admin {
      background: #ff6d00;
      color: white;
      font-size: 12px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: 8px;
    }

    .page {
      padding: 32px;
      opacity: 1;
      transform: translateY(0);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .page.hidden {
      position: absolute;
      opacity: 0;
      transform: translateY(20px);
      pointer-events: none;
    }

    .form-group {
      margin-bottom: 24px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: 500;
      color: #444;
    }

    input, textarea, select {
      width: 100%;
      padding: 14px;
      font-size: 16px;
      border: 1px solid var(--border);
      border-radius: 8px;
      transition: var(--transition);
    }

    input[type="date"] {
      -moz-appearance: textfield;
    }

    input:focus, textarea:focus, select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.15);
    }

    textarea {
      min-height: 140px;
      resize: vertical;
    }

    .btn {
      background: var(--primary);
      color: white;
      border: none;
      padding: 14px 24px;
      font-size: 16px;
      font-weight: 500;
      border-radius: 8px;
      cursor: pointer;
      transition: var(--transition);
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .btn:hover {
      background: var(--primary-dark);
      transform: translateY(-2px);
    }

    .btn:active {
      transform: translateY(0);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover {
      background: #e0e0e0;
    }

    .alert {
      padding: 16px;
      border-radius: 8px;
      margin: 20px 0;
      font-weight: 500;
      display: flex;
      align-items: center;
      opacity: 0;
      transform: translateY(-10px);
      transition: opacity 0.4s ease, transform 0.4s ease;
    }

    .alert.show {
      opacity: 1;
      transform: translateY(0);
    }

    .alert-success {
      background: #e8f5e9;
      color: var(--success);
      border: 1px solid #c8e6c9;
    }

    .nav {
      text-align: right;
      margin-bottom: 20px;
    }

    .nav a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
      transition: var(--transition);
    }

    .nav a:hover {
      color: var(--primary-dark);
    }

    /* –§–∏–ª—å—Ç—Ä—ã */
    .filters {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
      gap: 16px;
      margin: 24px 0;
    }

    .results-info {
      font-size: 14px;
      color: var(--gray-700);
      margin: 16px 0;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 10px;
    }

    .total-hours {
      font-weight: 600;
      color: var(--primary-dark);
      font-size: 16px;
    }

    /* –¢–∞–±–ª–∏—Ü–∞ */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
      border-radius: 8px;
      overflow: hidden;
      table-layout: fixed;
    }

    th, td {
      padding: 16px;
      text-align: left;
      font-size: 15px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: normal;
    }

    th {
      background: #f8f9fa;
      font-weight: 600;
      color: var(--gray-700);
      font-size: 14px;
    }

    td {
      border-bottom: 1px solid var(--border);
      vertical-align: top;
    }

    tr:last-child td {
      border-bottom: none;
    }

    .col-id { width: 10%; }
    .col-desc { width: 35%; }
    .col-client { width: 15%; }
    .col-status { width: 15%; }
    .col-hours { width: 15%; text-align: right; }
    .col-hours-client { width: 20%; text-align: right; }

    .status {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 13px;
      font-weight: 600;
    }

    .status-new { background: #e3f2fd; color: var(--primary); }
    .status-in_progress { background: #fff8e1; color: var(--warning); }
    .status-completed { background: #e8f5e8; color: var(--success); }

    .hours-cell {
      font-family: 'Roboto Mono', monospace;
      color: #555;
      text-align: right;
    }

    .file-upload {
      border: 2px dashed #bdbdbd;
      border-radius: 8px;
      padding: 20px;
      text-align: center;
      cursor: pointer;
      transition: var(--transition);
      background: #fafafa;
    }

    .file-upload:hover {
      border-color: var(--primary);
      background: #f0f9ff;
    }

    .file-list {
      margin-top: 16px;
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
    }

    .file-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 10px;
      display: flex;
      align-items: center;
      max-width: 200px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .file-preview {
      width: 40px;
      height: 40px;
      border-radius: 6px;
      object-fit: cover;
      margin-right: 10px;
      background: #eee;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #777;
    }

    .file-name {
      font-size: 13px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .remove-file {
      margin-left: auto;
      background: none;
      border: none;
      color: #f44336;
      cursor: pointer;
      font-weight: bold;
      padding: 0 6px;
    }

    @media (max-width: 768px) {
      .page { padding: 20px; }
      header { padding: 16px; }
      header h1 { font-size: 22px; }
      th, td { padding: 12px 8px; font-size: 14px; }
      .file-item { max-width: 150px; }
      table { display: block; overflow-x: auto; }
      .col-desc { min-width: 250px; }
    }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ø–æ–¥–¥–µ—Ä–∂–∫–∞ 1–° 
      <span id="role-badge"></span>
    </h1>
  </header>

  <div id="login-page" class="page">
    <h2>–í—Ö–æ–¥ –≤ –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
    <div class="form-group">
      <label for="email">–≠–ª–µ–∫—Ç—Ä–æ–Ω–Ω–∞—è –ø–æ—á—Ç–∞</label>
      <input type="email" id="email" value="user@example.com" autocomplete="off">
    </div>
    <div class="form-group">
      <label for="password">–ü–∞—Ä–æ–ª—å</label>
      <input type="password" id="password" value="123456">
    </div>
    <button class="btn" onclick="login()">–í–æ–π—Ç–∏</button>
    <p style="margin-top: 16px; font-size:14px; color:#777;">
      –ê–¥–º–∏–Ω: <code>admin@example.com</code> / <code>admin</code>
    </p>
  </div>

  <div id="client-page" class="page hidden">
    <div class="nav">
      <a href="#" onclick="logout()">–í—ã–π—Ç–∏</a>
    </div>
    <h2>–õ–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç</h2>
    <p>–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ, <strong id="user-name">–ö–ª–∏–µ–Ω—Ç</strong>!</p>
    <div id="message" class="alert alert-success"></div>
    <h3>–ù–æ–≤–∞—è –∑–∞—è–≤–∫–∞</h3>
    <div class="form-group">
      <label for="ticket-desc">–û–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã</label>
      <textarea id="ticket-desc" placeholder="–û–ø–∏—à–∏—Ç–µ –∑–∞–¥–∞—á—É..."></textarea>
    </div>
    <div class="form-group">
      <label>–ü—Ä–∏–∫—Ä–µ–ø–∏—Ç—å —Ñ–∞–π–ª—ã</label>
      <div class="file-upload" onclick="document.getElementById('file-input').click()">
        üìÅ –ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ —Ñ–∞–π–ª—ã –∏–ª–∏ –Ω–∞–∂–º–∏—Ç–µ –¥–ª—è –≤—ã–±–æ—Ä–∞
      </div>
      <input type="file" id="file-input" multiple accept=".jpg,.jpeg,.png,.pdf,.doc,.docx" style="display:none" onchange="handleFiles(this.files)">
      <div class="file-list" id="file-list"></div>
    </div>
    <button class="btn" onclick="submitTicket()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –∑–∞—è–≤–∫—É</button>
    <h3>–ú–æ–∏ –∑–∞—è–≤–∫–∏</h3>
    <div class="filters">
      <div><label>–ü–æ–∏—Å–∫</label><input type="text" id="search-input" oninput="applyFilters()"></div>
      <div><label>–°—Ç–∞—Ç—É—Å</label><select id="status-filter" onchange="applyFilters()">
        <option value="all">–í—Å–µ</option>
        <option value="new">–ü—Ä–∏–Ω—è—Ç–∞</option>
        <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
        <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
      </select></div>
      <div><label>–° –¥–∞—Ç—ã</label><input type="date" id="date-from" onchange="applyFilters()"></div>
      <div><label>–ü–æ –¥–∞—Ç—É</label><input type="date" id="date-to" onchange="applyFilters()"></div>
    </div>
    <div class="results-info">
      <span id="count-info">–ù–∞–π–¥–µ–Ω–æ: 0</span>
      <span class="total-hours">–°—É–º–º–∞—Ä–Ω–æ: <span id="total-hours">‚Äî</span></span>
    </div>
    <table>
      <thead>
        <tr>
          <th class="col-id">ID</th>
          <th class="col-desc">–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th class="col-status">–°—Ç–∞—Ç—É—Å</th>
          <th class="col-hours-client">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã (—á)</th>
        </tr>
      </thead>
      <tbody id="client-tickets-list"></tbody>
    </table>
  </div>

  <div id="admin-page" class="page hidden">
    <div class="nav">
      <a href="#" onclick="logout()">–í—ã–π—Ç–∏</a>
    </div>
    <h2>–ü–∞–Ω–µ–ª—å –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ <span class="badge-admin">–ê–î–ú–ò–ù</span></h2>
    <p>–ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö –∑–∞—è–≤–æ–∫ –æ—Ç –∫–ª–∏–µ–Ω—Ç–æ–≤.</p>
    <div id="admin-message" class="alert alert-success"></div>
    <h3>–í—Å–µ –∑–∞—è–≤–∫–∏</h3>
    <div class="filters">
      <div><label>–ü–æ–∏—Å–∫</label><input type="text" id="admin-search" oninput="applyAdminFilters()"></div>
      <div><label>–ö–ª–∏–µ–Ω—Ç</label><select id="admin-client" onchange="applyAdminFilters()"><option value="all">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option></select></div>
      <div><label>–°—Ç–∞—Ç—É—Å</label><select id="admin-status" onchange="applyAdminFilters()">
        <option value="all">–í—Å–µ</option>
        <option value="new">–ü—Ä–∏–Ω—è—Ç–∞</option>
        <option value="in_progress">–í —Ä–∞–±–æ—Ç–µ</option>
        <option value="completed">–í—ã–ø–æ–ª–Ω–µ–Ω–∞</option>
      </select></div>
      <div><label>–° –¥–∞—Ç—ã</label><input type="date" id="admin-date-from" onchange="applyAdminFilters()"></div>
      <div><label>–ü–æ –¥–∞—Ç—É</label><input type="date" id="admin-date-to" onchange="applyAdminFilters()"></div>
    </div>
    <div class="results-info">
      <span id="admin-count">–ù–∞–π–¥–µ–Ω–æ: 0</span>
      <span class="total-hours">–°—É–º–º–∞—Ä–Ω–æ: <span id="admin-total-hours">‚Äî</span></span>
    </div>
    <table>
      <thead>
        <tr>
          <th class="col-id">ID</th>
          <th class="col-desc">–û–ø–∏—Å–∞–Ω–∏–µ</th>
          <th class="col-client">–ö–ª–∏–µ–Ω—Ç</th>
          <th class="col-status">–°—Ç–∞—Ç—É—Å</th>
          <th class="col-hours">–¢—Ä—É–¥–æ–∑–∞—Ç—Ä–∞—Ç—ã (—á)</th>
        </tr>
      </thead>
      <tbody id="admin-tickets-list"></tbody>
    </table>
  </div>
</div>

<script>
  let allTickets = JSON.parse(localStorage.getItem('allTickets')) || [];
  const statuses = { new: '–ü—Ä–∏–Ω—è—Ç–∞', in_progress: '–í —Ä–∞–±–æ—Ç–µ', completed: '–í—ã–ø–æ–ª–Ω–µ–Ω–∞' };
  const statusClasses = { new: 'status-new', in_progress: 'status-in_progress', completed: 'status-completed' };
  let attachedFiles = [];
  let currentUser = null;

  // === –ì–µ–Ω–µ—Ä–∞—Ü–∏—è 15 –¥–µ–º–æ-–∑–∞—è–≤–æ–∫ –æ—Ç 5 –∫–ª–∏–µ–Ω—Ç–æ–≤ ===
  window.addEventListener('load', () => {
    if (allTickets.length === 0) {
      const now = new Date();
      const day = 24 * 60 * 60 * 1000;

      const clients = [
        'user@example.com',
        'client2@company.ru',
        'petrov@org.ru',
        'ivanova@firm.ru',
        'director@enterprise.com'
      ];

      allTickets = [
        // user@example.com
        { id: 'TKT-1001', description: '–ù–µ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç—Å—è –æ—Ç—á—ë—Ç "–ê–Ω–∞–ª–∏–∑ –ø—Ä–æ–¥–∞–∂" ‚Äî –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ.', status: 'completed', hours: 2.5, created_at: isoDate(now - 10 * day), user_email: clients[0] },
        { id: 'TKT-1002', description: '–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–≤–µ–¥–µ–Ω–∏–∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞ "–†–µ–∞–ª–∏–∑–∞—Ü–∏—è —Ç–æ–≤–∞—Ä–∞".', status: 'in_progress', hours: 1.0, created_at: isoDate(now - 3 * day), user_email: clients[0] },
        { id: 'TKT-1003', description: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫—É—Ä—Å–æ–≤ –≤–∞–ª—é—Ç.', status: 'new', hours: null, created_at: isoDate(now), user_email: clients[0] },
        { id: 'TKT-1004', description: '–ò—Å–ø—Ä–∞–≤–∏—Ç—å –æ—à–∏–±–∫—É –æ–∫—Ä—É–≥–ª–µ–Ω–∏—è –≤ –ø–ª–∞—Ç—ë–∂–Ω—ã—Ö –ø–æ—Ä—É—á–µ–Ω–∏—è—Ö.', status: 'completed', hours: 0.5, created_at: isoDate(now - 12 * day), user_email: clients[0] },

        // client2@company.ru
        { id: 'TKT-1005', description: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ï–ì–ê–ò–° –Ω–µ –ø–µ—Ä–µ–¥–∞—ë—Ç –¥–∞–Ω–Ω—ã–µ –ø–æ –æ—Å—Ç–∞—Ç–∫–∞–º.', status: 'completed', hours: 6.0, created_at: isoDate(now - 7 * day), user_email: clients[1] },
        { id: 'TKT-1006', description: '–ü–µ—á–∞—Ç–Ω–∞—è —Ñ–æ—Ä–º–∞ "–°—á—ë—Ç –Ω–∞ –æ–ø–ª–∞—Ç—É" –Ω–µ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –ù–î–°.', status: 'in_progress', hours: 0.75, created_at: isoDate(now - 1 * day), user_email: clients[1] },
        { id: 'TKT-1007', description: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —Ä–µ–∑–µ—Ä–≤–Ω–æ–µ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏–µ –±–∞–∑—ã 1 —Ä–∞–∑ –≤ —Å—É—Ç–∫–∏.', status: 'completed', hours: 1.5, created_at: isoDate(now - 15 * day), user_email: clients[1] },

        // petrov@org.ru
        { id: 'TKT-1008', description: '–û–±–Ω–æ–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ë—É—Ö–≥–∞–ª—Ç–µ—Ä–∏—è –¥–æ –≤–µ—Ä—Å–∏–∏ 3.0.120.', status: 'completed', hours: 4.0, created_at: isoDate(now - 5 * day), user_email: clients[2] },
        { id: 'TKT-1009', description: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å —ç–ª–µ–∫—Ç—Ä–æ–Ω–Ω—ã–π –¥–æ–∫—É–º–µ–Ω—Ç–æ–æ–±–æ—Ä–æ—Ç —Å –∫–æ–Ω—Ç—Ä–∞–≥–µ–Ω—Ç–∞–º–∏.', status: 'new', hours: null, created_at: isoDate(now - 2 * day), user_email: clients[2] },

        // ivanova@firm.ru
        { id: 'TKT-1010', description: '–ò—Å–ø—Ä–∞–≤–∏—Ç—å —Ä–∞—Å—á—ë—Ç –∞–≤–∞–Ω—Å–∞ –≤ –∑–∞—Ä–ø–ª–∞—Ç–Ω–æ–º –ø—Ä–æ–µ–∫—Ç–µ.', status: 'in_progress', hours: 2.25, created_at: isoDate(now - 4 * day), user_email: clients[3] },
        { id: 'TKT-1011', description: '–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é –∞–Ω–∞–ª–∏—Ç–∏–∫—É "–ü—Ä–æ–µ–∫—Ç" –≤ —É—á—ë—Ç –º–∞—Ç–µ—Ä–∏–∞–ª–æ–≤.', status: 'completed', hours: 3.0, created_at: isoDate(now - 8 * day), user_email: clients[3] },
        { id: 'TKT-1012', description: '–ù–∞—Å—Ç—Ä–æ–∏—Ç—å –æ—Ç–ø—Ä–∞–≤–∫—É –æ—Ç—á—ë—Ç–æ–≤ –ø–æ email –∫–∞–∂–¥–æ–µ —É—Ç—Ä–æ.', status: 'new', hours: null, created_at: isoDate(now - 1 * day), user_email: clients[3] },

        // director@enterprise.com
        { id: 'TKT-1013', description: '–ú–∏–≥—Ä–∞—Ü–∏—è –±–∞–∑—ã —Å 1–° 7.7 –Ω–∞ 1–° 8.3.', status: 'completed', hours: 20.0, created_at: isoDate(now - 20 * day), user_email: clients[4] },
        { id: 'TKT-1014', description: '–û–±—É—á–∏—Ç—å —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ —Ä–∞–±–æ—Ç–µ —Å –Ω–æ–≤—ã–º –º–æ–¥—É–ª–µ–º CRM.', status: 'in_progress', hours: 8.0, created_at: isoDate(now - 6 * day), user_email: clients[4] },
        { id: 'TKT-1015', description: '–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –≤–Ω–µ—à–Ω–µ–π —Å–∏—Å—Ç–µ–º–æ–π –ª–æ–≥–∏—Å—Ç–∏–∫–∏ —á–µ—Ä–µ–∑ API.', status: 'new', hours: null, created_at: isoDate(now), user_email: clients[4] }
      ];
      localStorage.setItem('allTickets', JSON.stringify(allTickets));
    }

    // –ó–∞–ø–æ–ª–Ω–∏—Ç—å –≤—ã–ø–∞–¥–∞—é—â–∏–π —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ
    const uniqueClients = [...new Set(allTickets.map(t => t.user_email))].sort();
    const clientSelect = document.getElementById('admin-client');
    clientSelect.innerHTML = '<option value="all">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>';
    uniqueClients.forEach(email => {
      const opt = document.createElement('option');
      opt.value = email;
      opt.textContent = email;
      clientSelect.appendChild(opt);
    });

    const today = isoDate(new Date());
    const sixtyDaysAgo = isoDate(new Date(Date.now() - 60 * 24 * 60 * 60 * 1000));
    ['date-from', 'admin-date-from'].forEach(id => document.getElementById(id).value = sixtyDaysAgo);
    ['date-to', 'admin-date-to'].forEach(id => document.getElementById(id).value = today);
  });

  function isoDate(date) {
    return date.toISOString().split('T')[0];
  }

  function login() {
    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;
    if (!email || !password) {
      alert('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è');
      return;
    }
    if (email === 'admin@example.com' && password === 'admin') {
      currentUser = { email, name: '–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä', role: 'admin' };
      showAdminPage();
    } else {
      currentUser = { email, name: email.split('@')[0], role: 'client' };
      showClientPage();
    }
  }

  function showClientPage() {
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('admin-page').classList.add('hidden');
    setTimeout(() => {
      document.getElementById('client-page').classList.remove('hidden');
      document.getElementById('user-name').textContent = currentUser.name;
      document.getElementById('role-badge').innerHTML = '';
      applyFilters();
    }, 300);
  }

  function showAdminPage() {
    document.getElementById('login-page').classList.add('hidden');
    document.getElementById('client-page').classList.add('hidden');
    setTimeout(() => {
      document.getElementById('admin-page').classList.remove('hidden');
      document.getElementById('role-badge').innerHTML = '<span class="badge-admin">–ê–î–ú–ò–ù</span>';
      applyAdminFilters();
    }, 300);
  }

  function logout() {
    currentUser = null;
    attachedFiles = [];
    document.getElementById('file-list').innerHTML = '';
    document.getElementById('client-page').classList.add('hidden');
    document.getElementById('admin-page').classList.add('hidden');
    setTimeout(() => document.getElementById('login-page').classList.remove('hidden'), 300);
  }

  function showMessage(text, isAdmin = false) {
    const el = isAdmin ? document.getElementById('admin-message') : document.getElementById('message');
    el.textContent = text;
    el.className = 'alert alert-success show';
    setTimeout(() => el.classList.remove('show'), 5000);
  }

  // === –ö–ª–∏–µ–Ω—Ç: –æ—Ç–ø—Ä–∞–≤–∫–∞ –∑–∞—è–≤–∫–∏ ===
  function handleFiles(files) {
    if (attachedFiles.length >= 3) {
      alert('–ú–∞–∫—Å. 3 —Ñ–∞–π–ª–∞');
      return;
    }
    const list = document.getElementById('file-list');
    for (let file of files) {
      if (attachedFiles.length >= 3) break;
      if (file.size > 10 * 1024 * 1024) continue;
      attachedFiles.push(file);
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerHTML = `
        <div class="file-preview">üìÑ</div>
        <div class="file-name" title="${file.name}">${file.name}</div>
        <button class="remove-file" onclick="removeFile(${attachedFiles.length - 1})">√ó</button>
      `;
      list.appendChild(item);
    }
  }

  function removeFile(index) {
    attachedFiles.splice(index, 1);
    document.getElementById('file-list').innerHTML = '';
    attachedFiles.forEach((f, i) => {
      const item = document.createElement('div');
      item.className = 'file-item';
      item.innerHTML = `
        <div class="file-preview">üìÑ</div>
        <div class="file-name" title="${f.name}">${f.name}</div>
        <button class="remove-file" onclick="removeFile(${i})">√ó</button>
      `;
      document.getElementById('file-list').appendChild(item);
    });
  }

  function submitTicket() {
    const desc = document.getElementById('ticket-desc').value.trim();
    if (!desc) {
      alert('–û–ø–∏—à–∏—Ç–µ –ø—Ä–æ–±–ª–µ–º—É');
      return;
    }

    const newTicket = {
      id: 'TKT-' + Date.now().toString().slice(-6),
      description: desc,
      status: 'new',
      hours: null,
      created_at: isoDate(new Date()),
      user_email: currentUser.email
    };

    allTickets.unshift(newTicket);
    localStorage.setItem('allTickets', JSON.stringify(allTickets));

    // –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫ –∫–ª–∏–µ–Ω—Ç–æ–≤ –≤ –∞–¥–º–∏–Ω–∫–µ (–µ—Å–ª–∏ –Ω–æ–≤—ã–π email)
    if (document.getElementById('admin-page').classList.contains('hidden') === false) {
      const uniqueClients = [...new Set(allTickets.map(t => t.user_email))].sort();
      const clientSelect = document.getElementById('admin-client');
      const currentVal = clientSelect.value;
      clientSelect.innerHTML = '<option value="all">–í—Å–µ –∫–ª–∏–µ–Ω—Ç—ã</option>';
      uniqueClients.forEach(email => {
        const opt = document.createElement('option');
        opt.value = email;
        opt.textContent = email;
        clientSelect.appendChild(opt);
      });
      clientSelect.value = currentVal; // —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –≤—ã–±–æ—Ä
    }

    showMessage('‚úÖ –ó–∞—è–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!');
    document.getElementById('ticket-desc').value = '';
    attachedFiles = [];
    document.getElementById('file-list').innerHTML = '';
    applyFilters();
  }

  function formatHours(hours) {
    return (hours === null || hours === 0) ? '‚Äî' : `${hours} —á`;
  }

  // === –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è ===
  function applyFilters() {
    if (!currentUser) return;
    const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
    const status = document.getElementById('status-filter').value;
    const from = document.getElementById('date-from').value;
    const to = document.getElementById('date-to').value;

    let filtered = allTickets.filter(t => 
      t.user_email === currentUser.email &&
      t.description.toLowerCase().includes(searchTerm) &&
      (status === 'all' || t.status === status) &&
      (!from || t.created_at >= from) &&
      (!to || t.created_at <= to)
    );

    const total = filtered.reduce((sum, t) => sum + (t.hours || 0), 0);
    renderTickets('client-tickets-list', filtered, false);
    document.getElementById('count-info').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${filtered.length}`;
    document.getElementById('total-hours').textContent = filtered.length ? `${total.toFixed(2)} —á` : '‚Äî';
  }

  function applyAdminFilters() {
    const searchTerm = document.getElementById('admin-search').value.toLowerCase().trim();
    const clientFilter = document.getElementById('admin-client').value;
    const status = document.getElementById('admin-status').value;
    const from = document.getElementById('admin-date-from').value;
    const to = document.getElementById('admin-date-to').value;

    let filtered = allTickets.filter(t =>
      t.description.toLowerCase().includes(searchTerm) &&
      (clientFilter === 'all' || t.user_email === clientFilter) &&
      (status === 'all' || t.status === status) &&
      (!from || t.created_at >= from) &&
      (!to || t.created_at <= to)
    );

    const total = filtered.reduce((sum, t) => sum + (t.hours || 0), 0);
    renderTickets('admin-tickets-list', filtered, true);
    document.getElementById('admin-count').textContent = `–ù–∞–π–¥–µ–Ω–æ: ${filtered.length}`;
    document.getElementById('admin-total-hours').textContent = filtered.length ? `${total.toFixed(2)} —á` : '‚Äî';
  }

  function renderTickets(containerId, ticketsToShow, isAdmin) {
    const container = document.getElementById(containerId);
    const cols = isAdmin ? 5 : 4;
    if (ticketsToShow.length === 0) {
      container.innerHTML = `<tr><td colspan="${cols}" style="text-align:center;padding:20px;color:#777;">–ó–∞—è–≤–∫–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</td></tr>`;
      return;
    }

    container.innerHTML = ticketsToShow.map(t => {
      const desc = t.description.length > 80 ? t.description.substring(0, 80) + '‚Ä¶' : t.description;
      if (isAdmin) {
        return `
          <tr>
            <td><code>${t.id}</code></td>
            <td>${desc}</td>
            <td>${t.user_email}</td>
            <td><span class="status ${statusClasses[t.status]}">${statuses[t.status]}</span></td>
            <td class="hours-cell">${formatHours(t.hours)}</td>
          </tr>
        `;
      } else {
        return `
          <tr>
            <td><code>${t.id}</code></td>
            <td>${desc}</td>
            <td><span class="status ${statusClasses[t.status]}">${statuses[t.status]}</span></td>
            <td class="hours-cell">${formatHours(t.hours)}</td>
          </tr>
        `;
      }
    }).join('');
  }
</script>

</body>
</html>